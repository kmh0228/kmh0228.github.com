//I am kmh0228 , QQ:1150123276
//插件说明
/*
该插件使用的是面向对象，纯原生插件，使用时需要new出来一个对象
例如 var cube=new Cube(id,opts);
//opts参数：
opts:{
	borderLength:num 魔方边长, 默认240px
	vColor:color，魔方材料颜色 ,默认#999
	colors:[[][][][][][]]，魔方各个面的颜色，默认正常魔方的颜色
	order:num 魔方阶乘 ,默认3阶
	mouseSen 拖拽时鼠标灵敏度 , 默认0.5
	oneTime 转动一下时需要的毫秒时间，默认500
	oneTimeBatch 批量扭动时转动一下所需要的时间 默认200
	turnOn:true  是否在魔方上点击扭动 默认是
	turnArrowColor:pink; 箭头颜色,默认PINK
	cache:true  是否缓存魔方信息，以便下次打开此浏览器继续
	turnBack:fn   每次扭动后的毁掉函数，参数为扭动的轴列方向 {coor:,num:,dir:}
	success:fn    魔方完成的毁掉函数
}

此对象的方法：
常用：
	turn(coor,num,dir,comebackfn);//基础的扭动方法,参数coor：扭动那个轴方向的魔方，num：扭动这个轴的第几层的魔方，dir：方向,正方向turn 反方向false，combackfn:扭动完成后的回掉函数
	turn3(t);//仅限于3阶魔方的扭动，t可为 u,u',b,b'……(三阶魔方的指令，'是反方向的意思);
	turn3s(ts);//仅限于3阶魔方,ts是三阶魔方指令的组合。例如 var ts='uu\'bb\'lr\'f';注意字符串中的'要转义
	initColor();//初始化魔方最开始的样子。步数同步清零
	initL();//初始化魔方旋转的角度
	getFoots();//返回当前已经扭的步数
	random(n);//随机打乱魔方，n为随机打乱的步数。默认30步
	back();//撤销一步

不常用：
	delColor();//干掉颜色。只剩材料颜色
	setColor(colors);//自己设定颜色,colors为2维数组
	setMouseSen(n);//设置鼠标拖拽魔方的灵敏度
	setOneTime(time);//设置魔方扭动速度- 毫秒时间。
*/
//参数  id为魔方容器的id，opts为魔方的属性设置
//opts  >success:魔方拼成功回掉函数    borderLength:num 魔方边长, vColor:color魔方材料颜色 , colors:[[][][][][][]]魔方各个面的颜色  order:num 魔方阶乘 , mouseSen 拖拽时鼠标灵敏度 , oneTime 转动一下时需要的时间
function Cube(id,opts){this.id=id;this.container=document.getElementById(id);this.opts=opts||{};this.order=this.opts.order||3;this.borderLength=this.opts.borderLength||240;this.boxBorderLength=parseInt(this.borderLength/this.order/2)*2;this.borderLength=this.boxBorderLength*this.order;this.vColor=this.opts.vColor||'#999';this.mouseSen=this.opts.mouseSen||0.5;this.oneTime=this.opts.oneTime||500;this.oneTimeBatch=this.opts.oneTimeBatch||200;this.cache=typeof this.opts.cache=='undefined'?true:this.opts.cache;this.cacheinfo=this.getCache();this.turnOn=typeof(this.opts.turnOn)=='undefined'?true:this.opts.turnOn;this.turnArrowColor=this.opts.turnArrowColor||'pink';this.turnBack=this.opts.turnBack;this.success=this.opts.success;this.record=[];this.foots=this.cacheinfo.foots||0;this.container.innerHTML='';this.boxsData=[];this.boxsDataLength=Math.pow(this.order,3);for(var i=0;i<this.boxsDataLength;i+=1){var boxs={};boxs.dom=document.createElement('div');this.container.appendChild(boxs.dom);boxs.faces=[];for(var j=0;j<6;j+=1){var aDiv=document.createElement('div');boxs.dom.appendChild(aDiv);boxs.faces.push(aDiv);}boxs.x=boxs.intx=i%this.order;boxs.y=boxs.inty=(parseInt(i/this.order))%this.order;boxs.z=boxs.intz=(parseInt(i/Math.pow(this.order,2)))%this.order;this.boxsData.push(boxs);}this.turnOn&&this.addArrow();this.initStyle();this.initColors=this.opts.colors||[['yellow'],['#fff'],['blue'],['green'],['red'],['orange']];this.colors=this.cacheinfo.colors||this.initColors;this.setColor(this.colors);this.containerMouseMove()}Cube.prototype.getCache=function(){if(!this.cache){return{}}return JSON.parse(localStorage['cube'+this.id+this.order]||'{}')};Cube.prototype.setCache=function(json){if(!this.cache){return}for(var name in json){this.cacheinfo[name]=json[name]}localStorage['cube'+this.id+this.order]=JSON.stringify(this.cacheinfo)};Cube.prototype.addArrow=function(){var order=this.order;var b=this.order-1;var filter=[{y:0},{y:b},{x:0},{x:b},{z:b},{z:0}];var coordir=[{up:{coor:'x',dir:1},bottom:{coor:'x',dir:0},left:{coor:'z',dir:0},right:{coor:'z',dir:1}},{up:{coor:'x',dir:0},bottom:{coor:'x',dir:1},left:{coor:'z',dir:1},right:{coor:'z',dir:0}},{up:{coor:'y',dir:0},bottom:{coor:'y',dir:1},left:{coor:'z',dir:1},right:{coor:'z',dir:0}},{up:{coor:'y',dir:1},bottom:{coor:'y',dir:0},left:{coor:'z',dir:0},right:{coor:'z',dir:1}},{up:{coor:'x',dir:1},bottom:{coor:'x',dir:0},left:{coor:'y',dir:0},right:{coor:'y',dir:1}},{up:{coor:'x',dir:0},bottom:{coor:'x',dir:1},left:{coor:'y',dir:1},right:{coor:'y',dir:0}}];for(var i=0;i<6;i+=1){var dom=this.getDomByPos(filter[i]);for(var j=0;j<dom.length;j+=1){if(parseInt(j/order)==0){dom[j].faces[i].innerHTML+='<div class="arrow top" coor="'+coordir[i].up.coor+'" num="'+(j%order)+'" dir="'+coordir[i].up.dir+'"></div>'}if(parseInt(j/order)==b){dom[j].faces[i].innerHTML+='<div class="arrow bottom" coor="'+coordir[i].bottom.coor+'" num="'+(j%order)+'" dir="'+coordir[i].bottom.dir+'"></div>'}if(j%order==0){dom[j].faces[i].innerHTML+='<div class="arrow left" coor="'+coordir[i].left.coor+'" num="'+parseInt(j/order)+'" dir="'+coordir[i].left.dir+'"></div>'}if(j%order==b){dom[j].faces[i].innerHTML+='<div class="arrow right" coor="'+coordir[i].right.coor+'" num="'+parseInt(j/order)+'" dir="'+coordir[i].right.dir+'"></div>'}}}var width=parseInt(this.boxBorderLength/2);var left=parseInt(this.boxBorderLength/4);var height=parseInt(this.boxBorderLength/5);var arr=this.container.getElementsByClassName('arrow');var arrtop=this.container.getElementsByClassName('top');var arrbottom=this.container.getElementsByClassName('bottom');var arrleft=this.container.getElementsByClassName('left');var arrright=this.container.getElementsByClassName('right');for(var i=0;i<arr.length;i+=1){arr[i].style.position='absolute';arr[i].style.cursor='pointer';arr[i].style.display='none';arr[i].style.width='0';arr[i].style.height='0'}var length=arrtop.length;for(var i=0;i<length;i+=1){arrtop[i].style.borderLeft=arrtop[i].style.borderRight=width/2+'px solid transparent';arrtop[i].style.borderBottom=height+'px solid '+this.turnArrowColor;arrtop[i].style.left=left+'px';arrtop[i].style.top=0;arrbottom[i].style.borderLeft=arrbottom[i].style.borderRight=width/2+'px solid transparent';arrbottom[i].style.borderTop=height+'px solid '+this.turnArrowColor;arrbottom[i].style.left=left+'px';arrbottom[i].style.bottom=0;arrleft[i].style.borderTop=arrleft[i].style.borderBottom=width/2+'px solid transparent';arrleft[i].style.borderRight=height+'px solid '+this.turnArrowColor;arrleft[i].style.top=left+'px';arrleft[i].style.left=0;arrright[i].style.borderTop=arrright[i].style.borderBottom=width/2+'px solid transparent';arrright[i].style.borderLeft=height+'px solid '+this.turnArrowColor;arrright[i].style.top=left+'px';arrright[i].style.right=0}for(var i=0;i<this.boxsDataLength;i+=1){var faces=this.boxsData[i].faces;for(var j=0;j<6;j+=1){faces[j].onmouseenter=function(){var arrs=this.getElementsByClassName('arrow');var length=arrs.length;for(var j=0;j<length;j+=1){arrs[j].style.display='block'}};faces[j].onmouseleave=function(){var arrs=this.getElementsByClassName('arrow');var length=arrs.length;for(var j=0;j<length;j+=1){arrs[j].style.display='none'}}}}var _this=this;for(var i=0;i<arr.length;i+=1){arr[i].onclick=function(){var coor=this.getAttribute('coor');var num=this.getAttribute('num');var dir=this.getAttribute('dir');_this.turn(coor,num,Number(dir))}}};Cube.prototype.initStyle=function(){var cacheinfo=this.cacheinfo;var x=this.rotateX=cacheinfo.x||0;var y=this.rotateY=cacheinfo.y||0;var z=this.rotateZ=cacheinfo.z||0;this.container.style.width=this.container.style.height=this.borderLength+'px';this.container.style.positon='relative';this.container.style.WebkitTransformStyle='preserve-3d';this.container.style.WebkitTransform='perspective(800px) rotateZ('+z+'deg) rotateY('+y+'deg) rotateX('+x+'deg)';for(var i=0;i<this.boxsDataLength;i+=1){this.boxsData[i].dom.style.position='absolute';this.boxsData[i].dom.style.width=this.boxsData[i].dom.style.height=this.boxBorderLength+'px';this.boxsData[i].dom.style.left=this.boxsData[i].dom.style.top=(this.order/2-0.5)*this.boxBorderLength+'px';var x=this.boxsData[i].translateX=(this.boxsData[i].x+0.5-(this.order/2))*this.boxBorderLength;var y=this.boxsData[i].translateY=(this.boxsData[i].y+0.5-(this.order/2))*this.boxBorderLength;var z=this.boxsData[i].translateZ=(this.boxsData[i].z+0.5-(this.order/2))*this.boxBorderLength;var rx=this.boxsData[i].rotateX=0;var ry=this.boxsData[i].rotateY=0;var rz=this.boxsData[i].rotateZ=0;this.boxsData[i].dom.style.WebkitTransformStyle='preserve-3d';this.boxsData[i].dom.style.WebkitTransform='rotateX('+rx+'deg) rotateY('+ry+'deg) rotateZ('+rz+'deg) translateZ('+z+'px) translate('+x+'px,'+y+'px)';for(var j=0;j<6;j+=1){this.boxsData[i].faces[j].style.position='absolute';this.boxsData[i].faces[j].style.top=this.boxsData[i].faces[j].style.left=0;this.boxsData[i].faces[j].style.width=this.boxsData[i].faces[j].style.height='100%';this.boxsData[i].faces[j].style.border='2px solid '+this.vColor;this.boxsData[i].faces[j].style.boxSizing='border-box';this.boxsData[i].faces[j].style.background=this.vColor;this.boxsData[i].faces[j].style.borderRadius=parseInt(this.boxBorderLength/10)+'px';var tx=0,ty=0,tz=0,rx=0,ry=0,rz=0;switch(j){case 0:ty= -this.boxBorderLength/2;rx=90;break;case 1:ty=this.boxBorderLength/2;rx=90;break;case 2:tx= -this.boxBorderLength/2;ry=90;rx=90;break;case 3:tx=this.boxBorderLength/2;ry=90;rx=90;break;case 4:tz=this.boxBorderLength/2;break;case 5:tz= -this.boxBorderLength/2;break}var transformstyle='';transformstyle+=tx?'translateX('+tx+'px) ':'';transformstyle+=ty?'translateY('+ty+'px) ':'';transformstyle+=tz?'translateZ('+tz+'px) ':'';transformstyle+=rx?'rotateX('+rx+'deg) ':'';transformstyle+=ry?'rotateY('+ry+'deg) ':'';transformstyle+=rz?'rotateZ('+rz+'deg) ':'';this.boxsData[i].faces[j].style.WebkitTransform=transformstyle;}}};Cube.prototype.delColor=function(){for(var i=0;i<this.boxsDataLength;i+=1){var doms=this.boxsData[i].faces;for(var j=0;j<6;j+=1){doms[j].style.backgroundColor=this.vColor}}};Cube.prototype.setColor=function(colorarr){var _this=this;this.delColor();this.colors=colorarr||(function(){var arr=[];for(var i=0;i<_this.initColors.length;i+=1){var subarr=_this.initColors[i].slice(0);arr.push(subarr)}return arr})();for(i=0;i<+6;i+=1){if(!this.colors[i]){this.colors[i]=this.colors[i-1]}for(var j=0;j<Math.pow(this.order,2);j+=1){if(!this.colors[i][j]){this.colors[i][j]=this.colors[i][j-1]}}}this.setCache({colors:this.colors});var b=this.order-1;var filter=[{y:0},{y:b},{x:0},{x:b},{z:b},{z:0}];for(var i=0;i<6;i+=1){var dom=this.getDomByPos(filter[i]);for(var j=0;j<dom.length;j+=1){dom[j].faces[i].style.background=this.colors[i][j]}}};Cube.prototype.initColor=function(){this.foots=0;this.setCache({foots:0});this.record=[];this.setColor()};Cube.prototype.getDomByPos=function(filterJson){var arr=[];var filterJson=filterJson||{};var x=/[\d+]/.test(filterJson.x)?filterJson.x:'all';var y=/[\d+]/.test(filterJson.y)?filterJson.y:'all';var z=/[\d+]/.test(filterJson.z)?filterJson.z:'all';for(var i=0;i<this.boxsDataLength;i+=1){if((this.boxsData[i].x==x||x=='all')&&(this.boxsData[i].y==y||y=='all')&&(this.boxsData[i].z==z||z=='all')){arr.push(this.boxsData[i])}}return arr};Cube.prototype.drag=function(obj,fndown,fnmove,fnup){if(!obj){return}if(arguments.length==2){var fnmove=fndown;fndown=null}var mousedown=function(ev){var oEvent=ev||event;var oldX=oEvent.clientX;var oldY=oEvent.clientY;fndown&&fndown();var mousemove=function(ev){var oEvent=ev||event;var newX=oEvent.clientX;var newY=oEvent.clientY;fnmove&&fnmove(newX-oldX,newY-oldY);oldX=newX;oldY=newY};document.addEventListener('mousemove',mousemove);var mouseup=function(){document.removeEventListener('mousemove',mousemove);document.removeEventListener('mousemove',mousemove);fnup&&fnup();obj.releaseCapture&&obj.releaseCapture()};document.addEventListener('mouseup',mouseup);obj.setCapture&&obj.setCapture();ev.preventDefault()};obj.addEventListener('mousedown',mousedown)};Cube.prototype.containerMouseMove=function(){var _this=this;this.oldRotateX=this.rotateX||0;this.oldRotateY=this.rotateX||0;this.oldRotateZ=this.rotateZ||0;var scale,scale2;var PIs=Math.PI/180;this.drag(_this.container,function(){},function(dx,dy){var dydeg=_this.rotateY%360;if(dydeg<0){dydeg+=360}if(dydeg>180){dydeg=360-dydeg}scale=Math.cos(dydeg*PIs);var dydeg2=_this.rotateY%360;if(dydeg2<0){dydeg2+=360}if(dydeg2>270){dydeg2=540-dydeg2}else if(dydeg2<90){dydeg2=180-dydeg2}scale2=Math.sin(dydeg2*PIs);_this.rotateY+=(dx*_this.mouseSen);_this.rotateX-=(dy*_this.mouseSen*scale);if(_this.rotateX>45){_this.rotateX=45}else if(_this.rotateX<-45){_this.rotateX=-45}_this.rotateZ-=(dy*_this.mouseSen*scale2);if(_this.rotateZ>45){_this.rotateZ=45}else if(_this.rotateZ<-45){_this.rotateZ=-45}_this.setCache({x:_this.rotateX,y:_this.rotateY,z:_this.rotateZ});_this.container.style.WebkitTransform='perspective(800px) rotateY('+_this.rotateY+'deg) rotateX('+_this.rotateX+'deg) rotateZ('+_this.rotateZ+'deg)'})};Cube.prototype.initL=function(){this.rotateX=this.rotateY=this.rotateZ=0;this.setCache({x:0,y:0,z:0});this.container.style.WebkitTransform='perspective(800px) rotateY('+this.rotateY+'deg) rotateX('+this.rotateX+'deg) rotateZ('+this.rotateZ+'deg)'};Cube.prototype.setMouseSen=function(n){this.mouseSen=n};Cube.prototype.trunRightColorChange=function(arr,n){if(!arr){return}var n=n||1;var cacheArr=[];var order=this.order;var length=arr.length;var cacheArr2=arr.slice(0);for(var i=0;i<n;i+=1){cacheArr=cacheArr2.slice(0);for(var j=0;j<length;j+=1){var dj=(j%order)*order+order-1-parseInt(j/order);cacheArr2[j]=cacheArr[dj]}}return cacheArr2};Cube.prototype.trunTabX=function(arr){if(!arr){return}var cacheArr=arr.slice(0);var order=this.order;var length=arr.length;var cacheArr2=[];for(var i=0;i<length;i+=1){var dj=(order-1-parseInt(i/order))*order+(i%order);cacheArr2[i]=cacheArr[dj]}return cacheArr2};Cube.prototype.trunTabY=function(arr){if(!arr){return}var cacheArr=arr.slice(0);var order=this.order;var length=arr.length;var cacheArr2=[];for(var i=0;i<length;i+=1){var dj=parseInt(i/order)*order+(order-1-i%order);cacheArr2[i]=cacheArr[dj]}return cacheArr2};Cube.prototype.reSetColorByTurnEnd=function(coor,num,dir){var nums=[];var order=this.order;var Morder=order*order;var name=['上','下','左','右','前','后'];for(var i=0;i<order;i+=1){nums.push(i)}var color0=this.colors[0].slice(0);var color1=this.colors[1].slice(0);var color2=this.colors[2].slice(0);var color3=this.colors[3].slice(0);var color4=this.colors[4].slice(0);var color5=this.colors[5].slice(0);switch(coor){case 'x':if(dir){for(var i=0;i<this.order;i+=1){var n=Number(num)+order*i;this.colors[0][n]=color4[n];this.colors[4][n]=this.trunTabX(color1)[n];this.colors[1][n]=color5[n];this.colors[5][n]=this.trunTabX(color0)[n]}if(num==0){this.colors[2]=this.trunRightColorChange(this.colors[2],3)}if(num==order-1){this.colors[3]=this.trunRightColorChange(this.colors[3],3)}}else{for(var i=0;i<this.order;i+=1){var n=Number(num)+order*i;this.colors[4][n]=color0[n];this.colors[1][n]=this.trunTabX(color4)[n];this.colors[5][n]=color1[n];this.colors[0][n]=this.trunTabX(color5)[n]}if(num==0){this.colors[2]=this.trunRightColorChange(this.colors[2],1)}if(num==order-1){this.colors[3]=this.trunRightColorChange(this.colors[3],1)}}break;case 'y':if(dir){for(var i=0;i<this.order;i+=1){var m=Number(num)+order*i;var n=Number(num)*order+i;this.colors[4][n]=this.trunTabY(this.trunRightColorChange(color2,3))[n];this.colors[3][m]=this.trunRightColorChange(color4,1)[m];this.colors[5][n]=this.trunRightColorChange(this.trunTabY(color3),1)[n];this.colors[2][m]=this.trunRightColorChange(color5,1)[m]}if(num==0){this.colors[0]=this.trunRightColorChange(this.colors[0],1)}if(num==order-1){this.colors[1]=this.trunRightColorChange(this.colors[1],1)}}else{for(var i=0;i<this.order;i+=1){var n=Number(num)+order*i;var m=Number(num)*order+i;this.colors[2][n]=this.trunTabY(this.trunRightColorChange(color4,3))[n];this.colors[4][m]=this.trunRightColorChange(color3,3)[m];this.colors[3][n]=this.trunRightColorChange(this.trunTabY(color5),1)[n];this.colors[5][m]=this.trunRightColorChange(color2,3)[m]}if(num==0){this.colors[0]=this.trunRightColorChange(this.colors[0],3)}if(num==order-1){this.colors[1]=this.trunRightColorChange(this.colors[1],3)}}break;case 'z':if(dir){for(var i=0;i<this.order;i+=1){var m=Number(num)*order+i;;this.colors[0][m]=this.trunTabY(color2)[m];this.colors[2][m]=color1[m];this.colors[1][m]=this.trunTabY(color3)[m];this.colors[3][m]=color0[m]}if(num==0){this.colors[5]=this.trunRightColorChange(this.colors[5],3)}if(num==order-1){this.colors[4]=this.trunRightColorChange(this.colors[4],3)}}else{for(var i=0;i<this.order;i+=1){var m=Number(num)*order+i;;this.colors[2][m]=this.trunTabY(color0)[m];this.colors[1][m]=color2[m];this.colors[3][m]=this.trunTabY(color1)[m];this.colors[0][m]=color3[m]}if(num==0){this.colors[5]=this.trunRightColorChange(this.colors[5],1)}if(num==order-1){this.colors[4]=this.trunRightColorChange(this.colors[4],1)}}break}this.setColor(this.colors)};Cube.prototype.setOneTime=function(n){this.oneTime=n};Cube.prototype.setOneTimeBatch=function(n){this.oneTimeBatch=n};Cube.prototype.turn=function(coor,num,dir,fnComplete){this.runing=this.runing||false;if(this.runing){return}var num=num||0;if(num>this.order-1){return}this.runing=true;if(dir==false){var dir=false}else{var dir=true};this.foots+=1;this.setCache({foots:this.foots});var filter={};filter[coor]=num;var dom=this.seletDoms=this.getDomByPos(filter);var n=0;var domLength=dom.length;var _this=this;function transend(){this.removeEventListener('transitionend',transend,false);this.style.transition='none';n+=1;if(n==domLength){_this.reSetColorByTurnEnd(coor,num,dir);for(var i=0;i<domLength;i+=1){dom[i].dom.style.WebkitTransform='rotateZ(0deg) rotateY(0deg) rotateX(0deg)  translateZ('+dom[i].translateZ+'px) translate('+dom[i].translateX+'px,'+dom[i].translateY+'px)'}_this.record.push({coor:coor,num:num,dir:dir});_this.runing=false;_this.turnBack&&_this.turnBack({coor:coor,num:num,dir:dir});_this.success&&(function(){var colors=_this.colors;var suc=true;for(var i=0;i<colors.length;i+=1){var colorsface=colors[i];for(var j=1;j<colorsface.length;j+=1){if(colorsface[j]!=colorsface[j-1]){suc=false;break}}}suc&&_this.success.call(_this)});fnComplete&&fnComplete()}}for(var i=0;i<domLength;i+=1){dom[i].dom.style.transition=this.oneTime/1000+'s all ease';var drx=0,dry=0,drz=0;var dirNumber=dir?1:-1;switch(coor){case 'x':drx=90*dirNumber;break;case 'y':dry=90*dirNumber;break;case 'z':drz=90*dirNumber;break}dom[i].dom.addEventListener('transitionend',transend,false);dom[i].dom.style.WebkitTransform='rotateZ('+drz+'deg) rotateY('+dry+'deg) rotateX('+drx+'deg)  translateZ('+dom[i].translateZ+'px) translate('+dom[i].translateX+'px,'+dom[i].translateY+'px)'}};Cube.prototype.turn3=function(type,fnComplete){if(this.order!=3){return}var fnComplete=fnComplete||function(){};var json={u:{'coor':'y',num:0,dir:true},u_:{'coor':'y',num:0,dir:false},d:{'coor':'y',num:2,dir:true},d_:{'coor':'y',num:2,dir:false},l:{'coor':'x',num:0,dir:true},l_:{'coor':'x',num:0,dir:false},r:{'coor':'x',num:2,dir:true},r_:{'coor':'x',num:2,dir:false},f:{'coor':'z',num:2,dir:true},f_:{'coor':'z',num:2,dir:false},b:{'coor':'z',num:0,dir:true},b_:{'coor':'z',num:0,dir:false}};var obj=json[type.replace('\'','_')];obj&&this.turn(obj.coor,obj.num,obj.dir,fnComplete)};Cube.prototype.turn3s=function(type,fnComplete){var type=type.replace(' ','');var arr=type.match(/\w\'?/g);var length=arr.length;var now=0;var _this=this;var time=this.oneTime;this.oneTime=this.oneTimeBatch;function dg(){_this.turn3(arr[now],function(){now+=1;if(now<length){var timeout=setTimeout(function(){clearTimeout(timeout);dg()},0)}else{_this.oneTime=time;fnComplete&&fnComplete()}})}if(length>0){dg()}};Cube.prototype.back=function(){var _this=this;var json=this.record.pop();if(json){this.turn(json.coor,json.num,!json.dir,function(){_this.record.pop()})}};Cube.prototype.getFoots=function(){return this.foots};Cube.prototype.getRandom=function(a,b){return parseInt(a+Math.random()*(b-a))};Cube.prototype.random=function(n){var _this=this;var n=n||30;var i=0;var speed=this.oneTime;var order=this.order;var coors=['x','y','z'];var linshi=parseInt(1000/n);this.oneTime=linshi<50?50:linshi;function turn_random(){i+=1;if(i>n){_this.oneTime=speed}else{var coor=coors[_this.getRandom(0,3)];var num=_this.getRandom(0,order);var dir=_this.getRandom(0,2);_this.turn(coor,num,dir,function(){var timeout=setTimeout(function(){clearTimeout(timeout);turn_random()},0)})}}turn_random()};